name: krknctl tests
on:
  pull_request:
jobs:
  test:
    name: krknctl tests
    runs-on: ubuntu-24.04
    steps:
      - name: Create multi-node KinD cluster
        uses: redhat-chaos/actions/kind@main
      - name: Code Checkout
        uses: actions/checkout@v4
      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.23.1'
      - name: Install Podman
        run: |
          sudo apt-get update && sudo apt-get install podman libbtrfs-dev nodejs
      - name: Setup Podman
        run: |
          echo "XDG_RUNTIME_DIR=/run/user/$UID" >> $GITHUB_ENV
          echo "PODMAN_SOCKET=$XDG_RUNTIME_DIR/podman/podman.sock" >> $GITHUB_ENV
          loginctl enable-linger $(whoami)
          podman system service --time=0 $PODMAN_SOCKET &
      - name: Set up test formatters
        run: |
          go install github.com/gotesttools/gotestfmt/v2/cmd/gotestfmt@latest
          go install github.com/ctrf-io/go-ctrf-json-reporter/cmd/go-ctrf-json-reporter@latest
      - name: Run Test suite
        run: |
         export USERID=$(id -u)
         go test -tags containers_image_openpgp -race -json -v  -coverprofile=coverage.out ./... 2>&1 | tee /tmp/gotest.log | gotestfmt
         cat /tmp/gotest.log | go-ctrf-json-reporter -output ctrf-report.json
      - name: Generate test report
        run: npx github-actions-ctrf ctrf-report.json
      - name: generate coverage report
        run: |
          COVERAGE=$(go tool cover -func coverage.out | grep total | awk '{print $3}')
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# TEST COVERAGE: $COVERAGE" >> $GITHUB_STEP_SUMMARY
          

